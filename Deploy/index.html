<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>DentalGPT - Tr·ª£ l√Ω nha khoa</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 font-sans">

  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">ü¶∑ DentalGPT - Tr·ª£ l√Ω ·∫£o nha khoa</h1>
    
    <div id="chat-box" class="bg-white shadow-xl rounded-lg p-4 h-[500px] overflow-y-auto space-y-4">
      <div class="text-gray-500 text-sm text-center">H√£y nh·∫≠p c√¢u h·ªèi nha khoa c·ªßa b·∫°n...</div>
    </div>

    <div class="mt-4 flex items-center gap-2">
      <input id="user-input" type="text" placeholder="Nh·∫≠p c√¢u h·ªèi..." class="flex-1 p-3 border rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="sendMessage('normal')" class="bg-blue-600 text-white px-5 py-2 rounded-xl hover:bg-blue-700">G·ª≠i</button>
      <button onclick="sendMessage('reason')" class="bg-purple-600 text-white px-5 py-2 rounded-xl hover:bg-purple-700">Suy lu·∫≠n üß†</button>
    </div>

    <div class="mt-2 flex gap-2 text-sm text-gray-700">
      <label>Tokens:</label><input id="max_tokens" type="number" value="50" class="w-16 border px-1 rounded-md">
      <label>Temp:</label><input id="temperature" type="number" step="0.1" value="0.7" class="w-16 border px-1 rounded-md">
      <label>Top P:</label><input id="top_p" type="number" step="0.1" value="0.9" class="w-16 border px-1 rounded-md">
    </div>
  </div>

  <script>
    const apiUrl = "http://localhost:8000/DentalGPT/chatbot/";

    function appendMessage(text, isUser) {
      const chatBox = document.getElementById("chat-box");
      const msg = document.createElement("div");
      msg.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
      msg.innerHTML = `
        <div class="${isUser ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-900'} p-3 rounded-xl max-w-[75%] whitespace-pre-wrap">
          ${text}
        </div>
      `;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage(mode = "normal") {
      const input = document.getElementById("user-input");
      const prompt = input.value.trim();
      if (!prompt) return;

      appendMessage(prompt, true);
      input.value = "";

      const params = {
        prompt: prompt,
        max_new_tokens: parseInt(document.getElementById("max_tokens").value),
        temperature: parseFloat(document.getElementById("temperature").value),
        top_p: parseFloat(document.getElementById("top_p").value),
        top_k: 50,
        repetition_penalty: 1.0,
        do_sample: true,
        mode: mode
      };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(params)
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.statusText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let botMsg = "";
        appendMessage("ƒêang tr·∫£ l·ªùi...", false);
        const lastMsg = document.querySelector("#chat-box > div:last-child div");

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          botMsg += decoder.decode(value, { stream: true });
          lastMsg.innerText = botMsg;
        }
      } catch (error) {
        appendMessage("ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß.", false);
        console.error("Error:", error);
      }
    }
  </script>
</body>
</html>
